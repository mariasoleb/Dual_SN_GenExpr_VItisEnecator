
## Prepare the data
```R
library(Seurat)
library(hdWGCNA)
library(WGCNA)
library(tidyverse)
library(cowplot)
library(patchwork)

set.seed(12345)
enableWGCNAThreads(nThreads = 8)

# Update the Seurat object and set the default assay as RNA 
j_obj_95_clean3 <- SeuratObject::UpdateSeuratObject(j_obj_95_clean2)
DefaultAssay(j_obj_95_clean3) <- "RNA" 

# Setup hdWGCNA
hd_obj <- SetupForWGCNA(
   seurat_obj = j_obj_95_clean3,
   gene_select = "fraction", 
   fraction = 0.001,
   wgcna_name = "Fungal_clusters") 


# Group by sample and cell type 
hd_obj <- MetacellsByGroups(
   seurat_obj = hd_obj,
   group.by = c("sample", "cell_type"),
   reduction = "umap",      # dimensionality method used
   k = 20,                  # number of neighbors
   max_shared = 10,          # max shared cells between metacells
   min_cells=30,
   ident.group = 'cell_type')


# Normalize metacell expression matrix:
hd_obj <- NormalizeMetacells(hd_obj)


# Prepare the expression data
hd_obj <- SetDatExpr(
   hd_obj,
   assay = 'RNA', # using RNA assay
   group_name = c("Appressoria C3","Appressoria C6", "Haustoria C7" ),
   group.by='cell_type',
   layer = 'data') # using normalized data
```


## Test different soft powers
```R
# Test different soft powers:
hd_obj <- TestSoftPowers(
   hd_obj, powers = c(seq(1, 11, by = 1), seq(12, 30, by = 1)),
   networkType = 'signed') 

# Plot the results:
plot_list <- PlotSoftPowers(hd_obj)

# Assemble with patchwork
pdf("plots/soft_power_selection_hd_0.001_sample_vs_cell_min30.pdf", width = 10, height = 10)
wrap_plots(plot_list, ncol=2)

dev.off()
```


## Construct a co-expression network
```R
# Construct co-expression network:
hd_obj <- ConstructNetwork(
   hd_obj,
   soft_power =8,
   tom_name = 'hdwgcna_fungal3', # name of the topological overlap matrix written to disk
   overwrite_tom = TRUE)

# Plot the dendrogram
pdf("plots/dendrogram_hdWGCNA_fungal_meta_sample_cell_min30.pdf", width = 8, height = 8)
PlotDendrogram(hd_obj, main='Fungal clusters')
dev.off()

# Get TOM
TOM <- GetTOM(hd_obj)
```

## Calculate module eigengenes (ME) and harmonized module eigengenes (hME)
```R
# Note: you need to run ScaleData first, or else Harmony throws an error:
hd_obj <- ScaleData(hd_obj, features=VariableFeatures(hd_obj))

# Compute all MEs in the full single-cell dataset
hd_obj <- ModuleEigengenes(
   hd_obj,
   group.by.vars="sample")

# Harmonized module eigengenes:
hMEs <- GetMEs(hd_obj)

# Module eigengenes:
MEs <- GetMEs(hd_obj, harmonized=FALSE)
```

## Calculate eigengene-based connectivity (kME)
```R
# Compute eigengene-based connectivity (kME):
hd_obj <- ModuleConnectivity(
   hd_obj,
   group.by = 'cell_type', group_name = c("Appressoria C3","Appressoria C6", "Haustoria C7" ))

# Rename the modules
hd_obj <- ResetModuleNames(
   hd_obj,
   new_name = "f_M")

# Plot genes ranked by kME for each module
pdf("plots/plotkme_hdWGCNA_fung_full.pdf", width = 25, height =25)

PlotKMEs(hd_obj, ncol=6)
dev.off()

```


## Get hub genes and module tables

```R
# Get the module assignment table:
modules <- GetModules(hd_obj) %>% subset(module != 'grey')

# Show the first 6 columns:
head(modules[,1:6])

# Get hub genes
hub_df <- GetHubGenes(hd_obj, n_hubs = 10)

head(hub_df)

# Save 
saveRDS(hd_obj, file='hdWGCNA_object.rds')
```


## Create feature plots with hME, ME, and hub genes

```R
# Compute gene scoring for the top 25 hub genes by kME for each module (with UCell method)
library(UCell)

hd_obj <- ModuleExprScore(
   hd_obj,
   n_genes = 25,
   method='UCell')

# Make a featureplot of hMEs for each module
plot_list <- ModuleFeaturePlot(
   hd_obj,
   features='hMEs',
   order=TRUE) # order so the points with the highest hMEs are on top


# Stitch together with patchwork
pdf("plots/feature_plot_fungi_hME.1.pdf", width = 25, height =25)
wrap_plots(plot_list, ncol=6)
dev.off()

# Make a featureplot of hub scores for each module
plot_list <- ModuleFeaturePlot(
   hd_obj,
   features='scores', # plot the hub gene scores
   order='shuffle', 
   ucell = TRUE) 

# Stitch together with patchwork
pdf("plots/feature_plot_fungi_hub.1.pdf", width = 25, height =25)
wrap_plots(plot_list, ncol=6)
dev.off()


# Make a featureplot of MEs for each module
plot_list <- ModuleFeaturePlot(
   hd_obj,
   features='MEs', # plot the hub gene scores
   order='shuffle', # order so cells are shuffled
   ucell = TRUE) # depending on Seurat vs UCell for gene scoring

# Stitch together with patchwork
pdf("plots/feature_plot_fungi_MEs.1.pdf", width = 25, height =25)
wrap_plots(plot_list, ncol=6)
dev.off()
```


## Create a radar plot with the relative expression in the clusters
```R
# Create a radar plot to visualize the relative expression level of each module across clusters
pdf("plots/radar_plot_fungi_all_clusters.pdf", width = 25, height =25)

ModuleRadarPlot(
   hd_obj,
   group.by = 'cell_type',
   barcodes = hd_obj@meta.data %>% subset(cell_type == c("Appressoria C3","Appressoria C6", "Haustoria C7" , 
                                                         "C0", "C1", "C2", "C4","C5")) %>% rownames(),
   axis.label.size=4,
   grid.label.size=4)

dev.off()
```

## Create a dotplot with the expression of the hMEs in the clusters
```R
# Create a dotplot with the expression of the hMEs in the clusters 
# Get hMEs from seurat object
MEs <- GetMEs(hd_obj, harmonized=TRUE)
modules <- GetModules(hd_obj)
mods <- levels(modules$module); mods <- mods[mods != 'grey']

# Add hMEs to Seurat meta-data:
hd_obj@meta.data <- cbind(hd_obj@meta.data, MEs)


# Plot with Seurat's DotPlot function
relevant <- c("fungal_M2", "fungal_M3","fungal_M4","fungal_M5","fungal_M7",
              "fungal_M8","fungal_M11","fungal_M20","fungal_M23","fungal_M24")
p <- DotPlot(hd_obj, features=relevant, group.by = 'cell_type')

# Flip the x/y axes, rotate the axis labels, and change color scheme:
p2 <- p +
   RotatedAxis() +
   scale_color_gradient2(high='red', mid='white', low='blue')+
   theme(panel.grid = element_line(color = "gray90", linewidth = 1))

# Plot output
ggsave("plots/dotplot_modules_hME_clusters.pdf", p2, width = 17, height = 10, units = "cm") 
```

