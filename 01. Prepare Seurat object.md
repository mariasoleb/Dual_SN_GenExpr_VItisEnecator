
## transform count matrix into seurat object rds format

```R
library(SingleCellExperiment)
library(Seurat)
library(fishpond)
custom_format <- list("counts" = c("U", "S", "A"),
                      "spliced" = c("S"),
                      "unspliced" = c("U"),
                      "ambiguous" = c("A"))



# load count matrix
sce <- fishpond::loadFry("./your_sample/af_quant",
                         outputFormat = custom_format)

```


## remove empty droplets
```R

library(DropletUtils)
bcrank <- barcodeRanks(counts(sce))

# Only showing unique points for plotting speed.
uniq <- !duplicated(bcrank$rank)
plot(bcrank$rank[uniq], bcrank$total[uniq], log="xy",
     xlab="Rank", ylab="Total UMI count", cex.lab=1.2)

abline(h=metadata(bcrank)$inflection, col="darkgreen", lty=2)
abline(h=metadata(bcrank)$knee, col="dodgerblue", lty=2)

legend("bottomleft", legend=c("Inflection", "Knee"), 
       col=c("darkgreen", "dodgerblue"), lty=2, cex=1.2)

# emptyDrops performs Monte Carlo simulations to compute p-values,
# so we need to set the seed to obtain reproducible results.
set.seed(100)
e.out <- emptyDrops(counts(sce))
??emptyDrops

# See ?emptyDrops for an explanation of why there are NA values.
summary(e.out$FDR <= 0.001)


# If any non-significant barcodes are TRUE for Limited, we may need to increase the number of iterations. A larger number of iterations will result in a lower  
# p-value for these barcodes, which may allow them to be detected after correcting for multiple testing.


table(Sig=e.out$FDR <= 0.001, Limited=e.out$Limited)



# Ideally, the distribution should be close to uniform (Figure 7.2). Large peaks near zero indicate that barcodes with total counts below lower are not all ambient in origin. This can be resolved by decreasing lower further to ensure that barcodes corresponding to droplets with very small cells are not used to estimate the ambient profile.
set.seed(100)
#set minimum amount of UMI
limit <- 150   
all.out <- emptyDrops(counts(sce), lower=limit, test.ambient=TRUE)
hist(all.out$PValue[all.out$Total <= limit & all.out$Total > 0],
     xlab="P-value", main="", col="grey80") 


#filter empty droplets

sce <- sce[,which(e.out$FDR <= 0.001)]



# create seurat object
seurat_obj <- CreateSeuratObject(counts(sce_filtered))


```
## filter low quality nuclei
```R
seurat_obj<-readRDS("./rds_outputs/your_sample.rds")

seurat_obj <- subset(seurat_obj, subset = nFeature_RNA > 200 & nFeature_RNA < 3000)

saveRDS(seurat_obj, file="./rds_outputs/your_sample_filt.rds")


```
## filter genes present in less than 3 cells

```R
# Access raw counts from the RNA assay
counts_matrix <- GetAssayData(seurat_obj, slot = "counts")

# Filter genes expressed in at least 3 cells
genes_to_keep <- rowSums(counts_matrix > 0) >= 3
seurat_obj <- subset(seurat_obj, features = names(genes_to_keep[genes_to_keep]))


```

## filter nuclei with high mitochondria, chloroplasts and E.necator reads  

```R
seurat_obj[["percent.mt"]] <- PercentageFeatureSet(seurat_obj, pattern = "ViviM")
seurat_obj[["percent.chl"]] <- PercentageFeatureSet(seurat_obj, pattern = "ViviC")
seurat_obj[["percent.En"]] <- PercentageFeatureSet(seurat_obj, pattern = "gene-HI914")

# seurat_obj<-readRDS("Sample2A_seurat.rds")
#visualize %En on umap

# head(seurat_obj@meta.data, 5)

seurat_obj$percent.mt[is.nan(seurat_obj$percent.mt)] <- 0
seurat_obj$percent.chl[is.nan(seurat_obj$percent.chl)] <- 0
seurat_obj$percent.En[is.nan(seurat_obj$percent.En)] <- 0


#visualize % reads mapped to E.necator
pdf("plots/PercentEN_UMAP.pdf", width = 5, height = 5)

FeaturePlot(seurat_obj, features = "percent.En", reduction = "umap", cols = c("lightgray", "red"))
dev.off()

#visualize % reads mapped to grapevine 
pdf("plots/PercentGrape_UMAP.pdf", width = 5, height = 5)

FeaturePlot(seurat_obj, features = "percent_grapevine", reduction = "umap", cols = c("lightgray", "green3"))
dev.off()

jpeg("plots/features_bySample.jpeg", width = 3000, height = 3000, res = 300)


# Visualize QC metrics as a violin plot
  VlnPlot(seurat_obj, features = c("nFeature_RNA", "nCount_RNA",
                      "percent.mt", "percent.chl", "percent.En"),
                 ncol = 5,pt.size = 0,  
          group.by = "Sample" )

  dev.off()

  ####filter cells####
  seurat_obj <- subset(seurat_obj, subset = percent.mt < 10)
  seurat_obj <- subset(seurat_obj, subset = percent.chl < 10)
  
  seurat_obj <- subset(seurat_obj, subset = percent.En < 10)




```
