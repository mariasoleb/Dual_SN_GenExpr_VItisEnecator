

```R


seurat_joined <- SetupForWGCNA(
  seurat_joined,
  gene_select = "fraction", # the gene selection approach
  fraction = 0.001, # fraction of cells that a gene needs to be expressed in order to be included
  wgcna_name = "tutorial" # the name of the hdWGCNA experiment
)
#estimate k
table(seurat_joined$Sample, seurat_joined$cluster_annotation_res0.6) / 20  # assuming k = 20


# construct metacells  in each group
seurat_hdWGCNA <- MetacellsByGroups(
  seurat_obj = seurat_joined,
  group.by = c("Sample",'cluster_annotation_res0.6'), # specify the columns in seurat_obj@meta.data to group by
  reduction = 'umap', # select the dimensionality reduction to perform KNN on
  k = 25, # nearest-neighbors parameter
  max_shared = 10, # maximum number of shared cells between two metacells
  min_cells = 30,  # Exclude tiny groups
  ident.group = 'cluster_annotation_res0.6' # set the Idents of the metacell seurat object
)

# normalize metacell expression matrix:
seurat_hdWGCNA <- NormalizeMetacells(seurat_hdWGCNA)


seurat_hdWGCNA <- SetDatExpr(
  seurat_hdWGCNA,
  group_name = "Epidermis", # the name of the group of interest in the group.by column
  group.by='cluster_annotation_res0.6', # the metadata column containing the cell type info. This same column should have also been used in MetacellsByGroups
  assay = 'RNA', # using RNA assay
  layer = 'data' # using normalized data
)

# Test different soft powers:
seurat_hdWGCNA <- TestSoftPowers(
  seurat_hdWGCNA,
  networkType = 'signed' # you can also use "unsigned" or "signed hybrid"
)

# plot the results:
plot_list <- PlotSoftPowers(seurat_hdWGCNA)

# assemble with patchwork
wrap_plots(plot_list, ncol=2)

power_table <- GetPowerTable(seurat_hdWGCNA)
head(power_table)


# construct co-expression network:
seurat_hdWGCNA <- ConstructNetwork(
  seurat_hdWGCNA,
  tom_name = 'hdwgcna_epidermis' # name of the topoligical overlap matrix written to disk
)
#Soft power not provided. Automatically using the lowest power that meets 0.8 scale-free topology fit. Using soft_power = 8

pdf("plots/dendrogram_Ep_hdWGCNA.pdf", width = 6, height = 6)
PlotDendrogram(seurat_hdWGCNA, main='Cluster Epidermis hdWGCNA Dendrogram')
dev.off()


TOM <- GetTOM(seurat_hdWGCNA)


# need to run ScaleData first or else harmony throws an error:
seurat_hdWGCNA <- ScaleData(seurat_hdWGCNA, features=VariableFeatures(seurat_hdWGCNA))

# compute all MEs in the full single-cell dataset
seurat_hdWGCNA <- ModuleEigengenes(
  seurat_hdWGCNA,
  group.by.vars="Sample"
)

# harmonized module eigengenes:
hMEs <- GetMEs(seurat_hdWGCNA)

# module eigengenes:
MEs <- GetMEs(seurat_hdWGCNA, harmonized=FALSE)


# compute eigengene-based connectivity (kME):
seurat_hdWGCNA <- ModuleConnectivity(
  seurat_hdWGCNA,
  group.by = 'cluster_annotation_res0.6', group_name = 'Epidermis'
)

# rename the modules
seurat_hdWGCNA <- ResetModuleNames(
  seurat_hdWGCNA,
  new_name = "Epidermis_M"
)




# plot genes ranked by kME for each module
pdf("plots/plotkme_Ep_hdWGCNA.pdf", width = 6, height = 12)

PlotKMEs(seurat_hdWGCNA, ncol=1)
dev.off()




# get the module assignment table:
modules <- GetModules(seurat_hdWGCNA) %>% subset(module != 'grey')



# get hub genes
hub_df <- GetHubGenes(seurat_hdWGCNA, n_hubs = 10)

head(hub_df)



# saveRDS(seurat_hdWGCNA, file='hdWGCNA_061225.rds')


# compute gene scoring for the top 25 hub genes by kME for each module
# with UCell method
library(UCell)
seurat_hdWGCNA <- ModuleExprScore(
  seurat_hdWGCNA,
  n_genes = 25,
  method='UCell'
)


# make a featureplot of hMEs for each module
plot_list <- ModuleFeaturePlot(
  seurat_hdWGCNA,
  features='hMEs', # plot the hMEs
  order=TRUE # order so the points with highest hMEs are on top
)

pdf("plots/featureplot_hme_Ep_hdWGCNA.pdf", width = 20, height = 5)

# stitch together with patchwork
wrap_plots(plot_list, ncol=7)
dev.off()

# make a featureplot of hub scores for each module
plot_list <- ModuleFeaturePlot(
  seurat_hdWGCNA,
  features='scores', # plot the hub gene scores
  order='shuffle', # order so cells are shuffled
  ucell = TRUE # depending on Seurat vs UCell for gene scoring
)

pdf("plots/featureplot_hub_Ep_hdWGCNA.pdf", width = 20, height = 5)

# stitch together with patchwork
wrap_plots(plot_list, ncol=7)
dev.off()


# Extract MEs
MEs <- GetMEs(seurat_hdWGCNA, harmonized=TRUE)

# Add metadata group labels
meta <- seurat_hdWGCNA@meta.data
grouping <- meta$cluster_annotation_res0.6

# Combine and average by group
MEs$group <- grouping
MEs_avg <- MEs %>%
  group_by(group) %>%
  summarise(across(where(is.numeric), mean)) %>%
  column_to_rownames("group")

# Convert to matrix
mat <- as.matrix(MEs_avg)

# Optional: define custom color palette
colors <- colorRampPalette(c("blue", "white", "red"))(100)

pdf("plots/heatmap_Ep_hdWGCNA.pdf", width = 20, height = 7)

# Base R heatmap
heatmap(
  mat,
  col = colors,
  scale = "row",           # scale rows to z-scores
  margins = c(8, 12),      # adjust margins for labels
  cexRow = 0.8,
  cexCol = 0.8,
  keep.dendro = FALSE      # optional: skip dendrograms
)
dev.off()




# get hMEs from seurat object
MEs <- GetMEs(seurat_hdWGCNA, harmonized=TRUE)
modules <- GetModules(seurat_hdWGCNA)
mods <- levels(modules$module); mods <- mods[mods != 'grey']

# add hMEs to Seurat meta-data:
seurat_hdWGCNA@meta.data <- cbind(seurat_hdWGCNA@meta.data, MEs)


# plot with Seurat's DotPlot function
p <- DotPlot(seurat_hdWGCNA, features=mods, group.by = 'cluster_annotation_res0.6')

# flip the x/y axes, rotate the axis labels, and change color scheme:
p <- p +
  RotatedAxis() +
  scale_color_gradient2(high='red', mid='grey95', low='blue')

# plot output
pdf("plots/dotplot_bycelltype_Ep_hdWGCNA.pdf", width = 20, height = 7)

p

dev.off()

###radar plot
seurat_obj$cluster <- do.call(rbind, strsplit(as.character(seurat_obj$celltype_cluster), ' '))[,1]

pdf("plots/radarplot_Ep_hdWGCNA.pdf", width = 20, height = 20)

ModuleRadarPlot(
  seurat_obj,
  group.by = 'celltype_cluster',
  # barcodes = seurat_obj@meta.data %>% subset(cell_type == 'INH') %>% rownames(),
  axis.label.size=4,
  grid.label.size=4
)
dev.off()


FeaturePlot(
  seurat_obj,
  features = "Epidermis_M1",
  split.by = "Treatment"
)

FeaturePlot(
  seurat_obj,
  features = "Epidermis_M2",
  split.by = "Treatment"
)

FeaturePlot(
  seurat_obj,
  features = "Epidermis_M3",
  split.by = "Treatment"
)

FeaturePlot(
  seurat_obj,
  features = "Epidermis_M4",
  split.by = "Treatment"
)

FeaturePlot(
  seurat_obj,
  features = "Epidermis_M5",
  split.by = "Treatment"
)

FeaturePlot(
  seurat_obj,
  features = "Epidermis_M6",
  split.by = "Treatment"
)

FeaturePlot(
  seurat_obj,
  features = "Epidermis_M7",
  split.by = "Treatment"
)




library(future)
options(future.globals.maxSize = 20 * 1024^3)  # Set to 20 GB

seurat_obj <- RunModuleUMAP(
  seurat_obj,
  n_hubs = 10, # number of hub genes to include for the UMAP embedding
  n_neighbors=15, # neighbors parameter for UMAP
  min_dist=0.1 # min distance between points in UMAP space
)
# get the hub gene UMAP table from the seurat object
umap_df <- GetModuleUMAP(seurat_obj)

# plot with ggplot
ggplot(umap_df, aes(x=UMAP1, y=UMAP2)) +
  geom_point(
    color=umap_df$color, # color each point by WGCNA module
    size=umap_df$kME*2 # size of each point based on intramodular connectivity
  ) +
  umap_theme()


library(ggrepel)
pdf("plots/networks_hdWGCNA.pdf", width = 5, height = 5)

ModuleUMAPPlot(
  seurat_obj,
  edge.alpha = 0.25,
  sample_edges = TRUE,
  edge_prop = 0.1,
  label_hubs = 1,
  keep_grey_edges = FALSE
)

dev.off()

seurat_obj$Treatment <- as.factor(seurat_obj$Treatment)

DoHubGeneHeatmap(
  seurat_obj,
  n_hubs = 10,
  n_cells = 200,
  group.by = "Treatment",  # correct usage
  module_names = NULL,
  combine = TRUE,
  draw.lines = TRUE,
  disp.min = -2.5,
  disp.max = 2.5
)


pdf("plots/networks_hub_hdWGCNA.pdf", width = 5, height = 5)

HubGeneNetworkPlot(
  seurat_obj,
  n_hubs = 3,
  n_other = 5,
  edge_prop = 0.75,
  mods = 'all'
)

dev.off()



# Create a binary matrix of traits
trait_mat <- model.matrix(~ 0 + Treatment, data = seurat_obj@meta.data)
colnames(trait_mat) <- gsub("Treatment", "", colnames(trait_mat))

# Add it to Seurat metadata
seurat_obj@meta.data <- cbind(seurat_obj@meta.data, trait_mat)

seurat_obj <- ModuleEigengenes(
  seurat_obj,
  wgcna_name = "tutorial"
)
module_trait_cor <- GetModuleTraitCorrelation(seurat_obj, wgcna_name = "tutorial")


####visualize hme per cluster ######

# Replace `your_wgcna_name` with the actual name, e.g. "tutorial"
hme_mat <- seurat_obj@misc$tutorial$hMEs

# Add hME scores to meta.data for aggregation
hme_df <- as.data.frame(hme_mat)
hme_df$cluster <- Idents(seurat_obj)[rownames(hme_df)]


library(dplyr)

hme_cluster_mean <- hme_df %>%
  group_by(cluster) %>%
  summarize(across(starts_with("Epidermis_M"), mean, .names = "{.col}")) %>%
  as.data.frame()

# Set cluster as rownames
rownames(hme_cluster_mean) <- hme_cluster_mean$cluster
hme_cluster_mean$cluster <- NULL


# Add hMEs to meta.data
for (mod in colnames(hme_mat)) {
  seurat_obj[[mod]] <- hme_mat[, mod]
}

# Then use DoHeatmap on selected modules
DoHeatmap(seurat_obj, features = c("Epidermis_M1", "Epidermis_M2", "Epidermis_M3"), group.by = "seurat_clusters")



# Extract hMEs from your Seurat object
hme_mat <- seurat_obj@misc$tutorial$hMEs  # replace 'tutorial' if your WGCNA slot is named differently

# Remove the grey module
hme_mat <- hme_mat[, !grepl("grey", colnames(hme_mat), ignore.case = TRUE)]

# Re-add to metadata if needed
seurat_obj <- AddMetaData(seurat_obj, metadata = hme_mat)

# Then plot (e.g., dotplot)
DotPlot(seurat_obj,
        features = colnames(hme_mat),
        group.by = "celltype_cluster") +
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  scale_size(range = c(3, 3)) +
  labs(title = "Module Eigengene (hME) Scores per Treatment") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

library(ggplot2)

DotPlot(seurat_obj,
        features = colnames(hme_mat),
        group.by = "celltype_cluster",
        split.by = "Treatment", 
        cols=c("green","orange","pink","purple")) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  scale_size(range = c(3, 3)) +
  labs(title = "Module Eigengene (hME) Scores per Cell Type, Faceted by Treatment") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 10),
        axis.text.y = element_text(size = 8))


# Ensure the rownames of hme_mat match the cells in Seurat
common_cells <- intersect(rownames(seurat_obj@meta.data), rownames(hme_mat))
seurat_obj@meta.data[common_cells, colnames(hme_mat)] <- hme_mat[common_cells, ]


library(reshape2)
library(dplyr)

# Extract needed columns
plot_df <- seurat_obj@meta.data %>%
  dplyr::select(celltype_cluster, Treatment, all_of(colnames(hme_mat))) %>%
  mutate(Cell = rownames(.)) %>%
  pivot_longer(cols = colnames(hme_mat), names_to = "Module", values_to = "hME")

# Group for plotting
plot_df_grouped <- plot_df %>%
  group_by(celltype_cluster, Treatment, Module) %>%
  summarise(mean_hME = mean(hME), .groups = "drop")


plot_df_grouped$Treatment <- factor(
  plot_df_grouped$Treatment,
  levels = c("Ctr_1DPI", "Inf_1DPI", "Ctr_5DPI", "Inf_5DPI")
)

pdf("plots/modules_pertrt_hdWGCNA.pdf", width = 10, height = 5)

ggplot(plot_df_grouped, aes(x = Module, y = celltype_cluster, color = mean_hME, size = abs(mean_hME))) +
  geom_point() +
  facet_wrap(~ Treatment, ncol = 4) +
  scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
  scale_size(range = c(2, 6)) +
  labs(title = "Module Eigengene (hME) Scores per Cell Type, Faceted by Treatment") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 10),
        axis.text.y = element_text(size = 8))
dev.off()



hdwgcna_genes<-read.csv("Modules_hdWGCNA_ann.csv")
DefenseGenes<-read.csv("DefenseGenes_CS08.csv")
DefenseGenes$gene_id <- gsub("_", "-", DefenseGenes$gene_id)  # Replace all hyphens with underscores
names(DefenseGenes)[3] <- "SeqName"


modules_defense_genes<-merge(hdwgcna_genes,DefenseGenes,by="SeqName",all=T)
library(dplyr)

# Step 1: Total number of genes per module (including those without Functional.category)
total_genes_per_module <- modules_defense_genes %>%
  group_by(module) %>%
  summarise(total_genes = n(), .groups = "drop")

# Step 2: Filter for genes with a defense-related Functional.category
df_defense <- modules_defense_genes %>%
  filter(!is.na(Functional.category) & Functional.category != "")

# Step 3: Count defense-related genes per category per module
genes_per_category <- df_defense %>%
  group_by(module, Functional.category) %>%
  summarise(genes_in_category = n(), .groups = "drop")

# Step 4: Join total genes per module and compute percentage
summary_df <- genes_per_category %>%
  left_join(total_genes_per_module, by = "module") %>%
  mutate(percent = round(100 * genes_in_category / total_genes, 2)) %>%
  arrange(module, desc(percent))

# View the result
print(summary_df)

write.csv(summary_df,"Modules_hdWGCNA_defensegenes.csv")



```


