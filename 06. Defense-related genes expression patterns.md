
## calculate module scores per defense related genes categories
```R
aba<-defensegenes[which(defensegenes$Functional.category=="Abscisic acid-mediated signaling pathway"),3]


features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-aba[aba %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "ABA_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/aba_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "ABA_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()

pdf("plots/ModScores/ABA_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "ABA_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()

genes<-defensegenes[which(defensegenes$Functional.category=="Cell wall reinforcement"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "Cellwall_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/cellwall_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "Cellwall_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()

pdf("plots/ModScores/CW_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "Cellwall_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()


genes<-defensegenes[which(defensegenes$Functional.category=="Jasmonic acid-mediated signaling pathway"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "JA_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/JA_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "JA_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/JA_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "JA_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()



genes<-defensegenes[which(defensegenes$Functional.category=="NLRs"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "NLRs_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/NLRs_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "NLRs_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/NLRs_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "NLRs_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()


genes<-defensegenes[which(defensegenes$Functional.category=="Phytoalexin biosynthesis"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "PA_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/PA_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "PA_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/PA_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "PA_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()


genes<-defensegenes[which(defensegenes$Functional.category=="Receptor-like kinases"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "RLK_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/RLK_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "RLK_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/RLK_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "RLK_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()


genes<-defensegenes[which(defensegenes$Functional.category=="ROS scavenging"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "ROSSCA_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/ROSSCA_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "ROSSCA_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/ROSSCA_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "ROSSCA_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()


genes<-defensegenes[which(defensegenes$Functional.category=="Calcium signaling"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "CA_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/CA_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "CA_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/CA_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "CA_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()


genes<-defensegenes[which(defensegenes$Functional.category=="Ethylene-mediated signaling pathway"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "ET_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/ET_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "ET_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/ET_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "ET_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()



genes<-defensegenes[which(defensegenes$Functional.category=="MAPK signaling"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "MAPK_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/MAPK_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "MAPK_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/MAPK_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "MAPK_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()



genes<-defensegenes[which(defensegenes$Functional.category=="NO production"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "NO_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/NO_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "NO_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/NO_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "NO_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()


genes<-defensegenes[which(defensegenes$Functional.category=="PR proteins"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "PR_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/PR_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "PR_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/PR_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "PR_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()





genes<-defensegenes[which(defensegenes$Functional.category=="ROS production"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "ROSPRO_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/ROSPRO_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "ROSPRO_defense1", 
            reduction = "umap", 
            pt.size = 0.2, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/ROSPRO_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "ROSPRO_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.2,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()


genes<-defensegenes[which(defensegenes$Functional.category=="Salicylic acid-mediated signaling pathway"),3]

features_available <- rownames(seurat_joined[["RNA"]])  # or "RNA" depending on default assay
present<-genes[genes %in% features_available]


seurat_joined <- AddModuleScore(
  object = seurat_joined,
  features = list(present),
  name = "SA_defense"
)



# This creates a metadata column named "ABA_defense1"

pdf("plots/ModScores/SA_modulescore.pdf", width = 5, height = 5)

FeaturePlot(seurat_joined, features = "SA_defense1", 
            reduction = "umap", 
            pt.size = 0.9, 
            min.cutoff = "q5", max.cutoff = "q95") + 
  scale_color_gradientn(colors = c("lightgrey", "yellow", "orange", "red")) 
dev.off()



pdf("plots/ModScores/SA_modulescore_bytrt.pdf", width = 20, height = 5)

FeaturePlot(
  seurat_joined,
  features = "SA_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.5,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all"
) & theme(legend.position = c(0.1,0.2))
# scale_color_gradient(colors = c("lightgrey", "yellow", "orange", "red"))
dev.off()

####compute top 
library(Seurat)
library(ggplot2)
library(dplyr)
library(patchwork)

# Step 1: Set a cutoff (e.g., top 10% of scores)
threshold <- quantile(seurat_joined$ROSPRO_defense1, 0.90, na.rm = TRUE)

# Step 2: Create a summary data frame with % high-scoring cells per treatment
df_pct <- seurat_joined@meta.data %>%
  dplyr::filter(!is.na(ROSPRO_defense1)) %>%
  group_by(Treatment) %>%
  summarise(
    total_cells = n(),
    high_score_cells = sum(ROSPRO_defense1 > threshold),
    percent_high = 100 * high_score_cells / total_cells
  )

# Step 3: Bar plot of % high-scoring cells per treatment
bar_plot <- ggplot(df_pct, aes(x = Treatment, y = percent_high, fill = Treatment)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  ylab("% High ROSPRO Module Score") +
  xlab("") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")

# Step 4: UMAP split by Treatment with color scale and legend
umap_plots <- FeaturePlot(
  seurat_joined,
  features = "ROSPRO_defense1",
  reduction = "umap",
  split.by = "Treatment",
  pt.size = 0.2,
  min.cutoff = "q5",
  max.cutoff = "q95",
  keep.scale = "all",
  combine = FALSE
)

umap_combined <- wrap_plots(umap_plots, nrow = 1) & 
  theme(legend.position = "right")

# Step 5: Combine UMAP + bar plot
final_plot <- plot_grid(umap_combined, bar_plot, rel_widths = c(4, 1), nrow = 1)

# Save to PDF
pdf("plots/ModScores/ROSPRO_modulescore_bytrt.pdf", width = 20, height = 5)
print(final_plot)
dev.off()

```
