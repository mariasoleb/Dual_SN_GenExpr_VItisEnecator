

```R
DefaultAssay(seurat_obj)<- 'RNA'
seurat_joined <- JoinLayers(seurat_obj)
Idents(seurat_joined)<-"integrated_snn_res.0.6"


annotation.df<-read.csv("./your_annotation_file")


#find markers between all clusters
all_markers<-FindAllMarkers(seurat_joined,
                            logfc.threshold = 0.1,
                            min.pct = 0.05,
                            test.use = 'wilcox')


all_markers<-all_markers[which(all_markers$p_val_adj<0.05),]
all_markers<-merge(annotation.df_unique, all_markers, by="gene_ID", all=F)
write.csv(all_markers, "./all_markers_res0.6.csv")

#check specific cluster comparisons
comp <- FindMarkers(seurat_joined, ident.1="5", ident.2="2")


```

## visualize cell type markers from the literature and Seurat

```R
#umap visualization 
library(ggplot2)
library(Seurat)

# Define the function to visualize genes of interest
visualize_genes <- function(seurat_obj, genes, output_folder) {
  # Create output folder if it doesn't exist
  if (!dir.exists(output_folder)) {
    dir.create(output_folder)
  }
  
  # Loop through each gene and create a FeaturePlot
  for (gene in genes) {
    if (gene %in% rownames(seurat_obj)) {
      
      # Generate the FeaturePlot
      plot <- FeaturePlot(seurat_obj, 
                          reduction = "umap", 
                          features = gene)
      
      # Save the plot as a PNG file
      plot_file <- paste0(output_folder, "/", gene, "_FeaturePlot.png")
      ggsave(plot_file, plot = plot, width = 8, height = 6)
    }else {
      message(paste("Gene", gene, "not found in Seurat object. Skipping..."))
    }
  }
}

genes_of_interest <- readLines("./gene_markers.txt")

# Define the Seurat object
obj <- readRDS("./your_sample.rds") # Replace with your Seurat object
DefaultAssay(obj)<-'RNA'

# Define the output folder to save the plots
output_folder <- "./UMAPs"

# Call the function to visualize and save plots for each gene
visualize_genes(obj, genes_of_interest, output_folder)


#heatmap
marker_genes <- readLines("./gene_markers.txt")

DefaultAssay(seurat_obj)<-'RNA'
marker_genes <- marker_genes[marker_genes %in% rownames(seurat_int)]

Idents(seurat_obj) <- seurat_obj$integrated_snn_res.0.6

# Calculate average expression per cluster
avg_exp <- AggregateExpression(seurat_obj, features = marker_genes, return.seurat = FALSE)$RNA

# Scale the data (optional, improves heatmap visualization)
scaled_avg <- t(scale(t(avg_exp)))  # scale each gene across clusters

# Plot the heatmap
p<-pheatmap(scaled_avg,
         cluster_rows = TRUE,       # cluster genes
         cluster_cols = TRUE,       # cluster clusters
         show_rownames = F,
         show_colnames = TRUE,
         fontsize = 10,
         main = "Average Expression of Marker Genes per Cluster")

#violin plots

row_hc<-p$tree_row

gene_clusters<-cutree(row_hc, k=14)

library(Seurat)
library(ggplot2)
library(patchwork)  # For arranging plots

# 1. Order genes by their heatmap cluster and optionally by gene name
ordered_genes <- names(sort(gene_clusters))  # this keeps them grouped by cluster

# 2. Optional: Check which genes are in the Seurat object
valid_genes <- intersect(ordered_genes, rownames(seurat_obj))

# 3. Generate violin plots
plots <- lapply(valid_genes, function(gene) {
  VlnPlot(seurat_obj, features = gene, group.by = "integrated_snn_res.0.6", pt.size = 0.1) +
    ggtitle(gene) +
    theme(plot.title = element_text(size = 10))
})


```

## cluster annotation 

```R

# # Vector to map cluster numbers to full names
# cluster_labels <- c(
#   "17" = "Xylem_parenchyma_17",
#   "16" = "Xylem_parenchyma_16",
#   "11" = "Phloem_parenchyma_11",
#   "10" = "Phloem_parenchyma_10",
#   "5"  = "Mesophyll_5",
#   "4"  = "Mesophyll_4",
#   "20" = "Mesophyll_20",
#   "2"  = "Mesophyll_2",
#   "15" = "Mesophyll_15",
#   "13" = "Mesophyll_13",
#   "12" = "Mesophyll_12",
#   "1"  = "Mesophyll_1",
#   "0"  = "Mesophyll_0",
#   "19" = "Guard_cells_19",
#   "9"  = "Epidermis_9",
#   "8"  = "Epidermis_8",
#   "7"  = "Epidermis_7",
#   "6"  = "Epidermis_6",
#   "3"  = "Epidermis_3",
#   "14" = "Epidermis_14",
#   "18" = "Companion_cells_18"
# )

seurat_obj$celltype_cluster <- paste0(seurat_obj$cluster_annotation_res0.6, "_", as.character(seurat_obj$integrated_snn_res.0.6))


shade_colors<-c("#D62728",#companion cells
                "purple4", "#9467BD","#E377C2",  "blueviolet", "darkmagenta","darkviolet",#epidermis
                "dodgerblue3", #guardcells
                "darkgreen","darkolivegreen3","chartreuse","darkolivegreen","darkolivegreen4","chartreuse3","chartreuse2","chartreuse4", "darkolivegreen2", #mesophyll
                "darkred",  "#8C564B",#phloem
                "#FF7F0E","coral1") #xylem


pdf("plots/umap_annot_060325.pdf", width = 10, height = 5)

DimPlot(seurat_obj, group.by = "celltype_cluster", cols = shade_colors) 
dev.off()



p1<- DimPlot(seurat_subset, reduction = 'umap', group.by = 'Treatment', label=F)
p2<- DimPlot(seurat_subset, reduction = 'umap', group.by = 'Sample', label=F)
p3<-DimPlot(seurat_subset, group.by = "celltype_cluster", cols = shade_colors) 


pdf("plots/umap_final1_060325.pdf", width = 10, height = 5)

# Draw the arranged plots
grid.arrange(p1, p2, ncol = 2)
# Close the graphics device
dev.off()
```
