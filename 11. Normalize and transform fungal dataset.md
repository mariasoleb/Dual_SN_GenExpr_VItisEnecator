## Normalize dataset

```R
# Normalize, find Variable features, Scale, PCA
obj <- j_obj_95_clean  
obj <- NormalizeData(obj, normalization.method = "LogNormalize", scale.factor = 10000)
obj <- FindVariableFeatures(obj, selection.method = "mean.var.plot", nfeatures = 2000)
obj <- ScaleData(obj, features = VariableFeatures(obj))
obj <- RunPCA(obj, features = VariableFeatures(obj))

assign(j_obj_95_clean, obj)  # Overwrite the original object

# Produce an elbow plot and select the number of dimensions to use later
Plot <- ElbowPlot(obj)
ggsave( plot = Plot, "plots/95_clean_elbow_plot.png", width = 8, height = 8, units = "cm")

```

## Create a UMAP with the normalized data

```R
library(patchwork)

# After checking the number of dimensions to use 
# Create the UMAP
obj <- j_obj_95_clean 
obj <- FindNeighbors(object = obj, dims = 1:10)
obj <- FindClusters(object = obj)
obj <- RunUMAP(object = obj, dims = 1:10)

# Save back
assign(j_obj_95_clean, obj)
   
# Plot UMAPs 
p1 <- DimPlot(obj, reduction = 'umap', group.by = 'Sample')
p2 <- DimPlot(obj, reduction = 'umap', group.by = 'Treatment')
p3 <- DimPlot(obj, reduction = 'umap', group.by = 'seurat_clusters', label = T)

combined_plot <- p1 | p2 | p3
ggsave( plot = combined_plot, "plots/95_UMAP_Sam_Treat_cluster_clean10.pdf", width = 30, height = 8, 
        units = "cm")
```


##  SCTransform the dataset
```R
## SCT transform the data and get the PCA
obj <- j_obj_95_clean
obj <- SCTransform(object = obj)
obj <- RunPCA(obj, npcs = 50, assay = "SCT")

# Save back
assign(j_obj_95_clean, obj)

# Produce an elbow plot and select the number of dimensions to use later
Plot <- ElbowPlot(obj, ndims = 50)
ggsave( plot = Plot, "plots/95_clean_elbow_plot_SCT.png", width = 8, height = 8, units = "cm")
```

## Create a UMAP with the transformed data
```R
# Set a custom color palette
palette6 <- c("grey75", "grey70","grey65","grey30","grey18","grey22","grey35","gray99") 

# Create the UMAP
obj <- j_obj_95_clean
obj <- FindNeighbors(object = obj, dims = 1:15, assay = "SCT")
obj <- FindClusters(object = obj, resolution = 0.3)
obj <- RunUMAP(object = obj, dims = 1:15, assay = "SCT")

# Plot UMAPs  
p1 <- DimPlot(obj, reduction = 'umap', group.by = 'Sample', pt.size = 0.1)
p2 <- DimPlot(obj, reduction = 'umap', group.by = 'Treatment', pt.size = 0.1)
p3 <- DimPlot(obj, reduction = 'umap', group.by = '', label = T, "seurat_clusters" , pt.size = 0.08, 
              cols = palette6)

combined_plot <- p1 | p2 | p3
ggsave( plot = combined_plot, "plots/95_UMAP_Sam_Treat_cluster_clean_SCT_res0.3.3.pdf", width = 30, 
        height = 7, units = "cm")
    
# Save back   
assign(j_obj_95_clean2,  obj)

```
