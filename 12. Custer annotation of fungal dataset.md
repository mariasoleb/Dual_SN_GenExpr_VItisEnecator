## Find markers for every cluster compared to all remaining cells

```R
# Get object
obj <- j_obj_95_clean2

# Set cluster identity to the resolution selected previously
Idents(obj) <- obj$SCT_snn_res.0.3

# Find markers per cluster and report only the positives
markers1 <- FindAllMarkers(obj, only.pos = T, logfc.threshold = 1)
markers1 %>%
   group_by(cluster) %>%
   dplyr::filter(abs(avg_log2FC) > 1)
   
j_95_pos_markers_0.3  <- markers1

# Save the results in a table   
write.table(markers1, file = "95_all_markers_0.3.txt", row.names = FALSE, sep = "\t")

```


## Extract the normalized expression data per cluster 

```R
# Get expression data per cluster
library(Seurat)
library(tidyverse)

#  Set cluster identities
Idents(j_obj_95_clean2) <- "SCT_snn_res.0.3"

#  Get log-normalized expression matrix
expr_data <- GetAssayData(j_obj_95_clean2, assay = "RNA", slot = "data")

# set variables for loop
clusters <- levels(Idents(j_obj_95_clean2))
treatment_levels <- unique(j_obj_95_clean2$Treatment)
results_list <- list()

# Loop over each cluster
for (clust in clusters) {
   message("Processing cluster: ", clust)
   
   # Cells in this cluster
   cells_clust <- WhichCells(j_obj_95_clean2, idents = clust)
   
   # Subset metadata for those cells
   meta_clust <- j_obj_95_clean2@meta.data[cells_clust, , drop = FALSE]
   
   # Subset expression data for this cluster
   expr_clust <- expr_data[, cells_clust, drop = FALSE]
   
   # Compute avg expression  and detection rate for the cluster (all treatments combined)
   avg_expr_clust <- Matrix::rowMeans(expr_clust)
   det_rate_clust <- Matrix::rowMeans(expr_clust > 0)
   
   df_clust <- data.frame(
      gene = rownames(expr_clust),
      cluster = clust,
      treatment = "All",
      avg_expr = avg_expr_clust,
      det_rate = det_rate_clust) %>%
      filter(det_rate > 0.1) ## keep when expression is in more than 10% of nuclei in any given cluster 
   
   results_list[[paste0(clust, "_All")]] <- df_clust
   
   # Now compute avg expression  and detection rate per cluster in each treatment
   for (treat in treatment_levels) {
      message("   Treatment: ", treat)
      
      treat_cells <- rownames(meta_clust)[meta_clust$Treatment == treat]
      
      if (length(treat_cells) < 2) {
         message("     Skipping treatment '", treat, "' in cluster ", clust, " (fewer than 2 cells)")
         next
      }
      
      expr_sub <- expr_data[, treat_cells, drop = FALSE]
      avg_expr <- Matrix::rowMeans(expr_sub)
      det_rate <- Matrix::rowMeans(expr_sub > 0)
      
      df <- data.frame(
         gene = rownames(expr_sub),
         cluster = clust,
         treatment = treat,
         avg_expr = avg_expr,
         det_rate = det_rate
      ) %>%
         filter(det_rate > 0.0) # the lack of a threshold here is just to check any expression at 1dpi and 5dpi 
      
      results_list[[paste0(clust, "_", treat)]] <- df
   }
}

#  Combine results
expression_summary_filtered <- do.call(rbind, results_list)

#  Add a type column
expression_summary_filtered$type <- ifelse(expression_summary_filtered$treatment == "All", "Cluster", "Cluster-Treatment")

#  Exploratory plot
p <- ggplot(expression_summary_filtered, aes(x = det_rate, y = avg_expr)) +
   geom_point(alpha = 0.3, size = 0.7) +
   geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
   facet_wrap(~ paste(cluster, treatment, sep = "_"), scales = "free") +
   theme_minimal(base_size = 12) +
   labs(title = "Detection rate vs Average expression per cluster and treatment",
        x = "Detection rate",
        y = "Average expression (RNA log-normalized)")

ggsave(filename = "plots/Detection_vs_AvgExpr_perClusterTreatment_filtered_1.pdf",
       plot = p, width = 20, height = 18, units = "cm")


# Quantile bin classification to determine high, medium, or low average expression, scaled to the maximum and minimum per cluster. 
classified_df <- expression_summary_filtered %>%
   group_by(cluster, treatment) %>%
   mutate(expression_bin = cut(avg_expr,
         breaks = quantile(avg_expr, probs = c(0, 0.25, 0.75, 1), na.rm = TRUE), # between 0-25 = low, between 25-75 = medium, and between 75-100 = high
         labels = c("low", "medium", "high"),
         include.lowest = TRUE),
         cuts = factor(expression_bin, labels = c("up to 25th", "25th - 75th", "above 75th"))) %>%
   ungroup()

# Save table
write.table(classified_df,
            file = "expression_bins_per_cluster_treatment.tsv",
            sep = "\t", row.names = FALSE, quote = FALSE)

```


# Rename clusters with identified fungal structure
#### The results of FindAllMarkers and the log-normalized expression were used to identify known markers for haustoria and appressoria presented in the literature. This was used to rename the clusters in our dataset.

#### Additionally, this combination of results was also used to define the new potential markers presented in the manuscript. 

```R
# Set new name combinations 
new_cluster_names <- c("0" = "C0", "1" = "C1", "2" = "C2", "3" = "Appressoria C3", "4" = "C4",
                       "5" = "C5", "6" = "Appressoria C6", "7" = "Haustoria C7")

# Rename the clusters 
j_obj_95_clean2 <- RenameIdents(j_obj_95_clean2, new_cluster_names)
j_obj_95_clean2$cell_type <- Idents(j_obj_95_clean2)
table(j_obj_95_clean2$cell_type)

```

