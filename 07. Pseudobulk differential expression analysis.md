```R


head(seurat_obj@meta.data)
seurat_obj$sample_trt <- paste0(seurat_obj$Sample, seurat_obj$Treatment)

DefaultAssay(seurat_obj)

cts <- AggregateExpression(seurat_obj, 
                           group.by = c("integrated_snn_res.0.6", "sample_trt"),
                           assays = 'RNA',
                           # layer = "counts",
                           return.seurat = FALSE)

cts <- cts$RNA
filtered_cts <- cts[!grepl("^gene-HI914", rownames(cts)), ]
# > dim(filtered_cts)
# [1] 33717   313
# transpose
cts.t <- t(filtered_cts)


# convert to data.frame
cts.t <- as.data.frame(cts.t)

# get values where to split
splitRows <- gsub('_.*', '', rownames(cts.t))


# split data.frame
cts.split <- split.data.frame(cts.t,
                              f = factor(splitRows))

cts.split$g0[1:10,1:10]


# fix colnames and transpose

cts.split.modified <- lapply(cts.split, function(x){
  rownames(x) <- gsub('.*_(.*)', '\\1', rownames(x))
  t(x)
  
})

#gsub('.*_(.*)', '\\1', 'g20_Sample10Inf-5DPI')


seurat_subset <- subset(seurat_obj, subset = Sample %in% c("Sample1", "Sample2", "Sample3",
                                                          "Sample4", "Sample5", "Sample6",
                                                          "Sample7", "Sample8", "Sample9",
                                                          "Sample10", "Sample11", "Sample12"))

DimPlot(seurat_subset, group.by = "celltype_cluster", cols = shade_colors) 



library(limma)
library(edgeR)
library(tidyr)
library(ggplot2)
library(ggrepel)
library(dplyr)

for (i in 0:20) {
  # 1. Get counts matrix for current cluster
  counts <- cts.split.modified[[paste0("g", i)]]
  
  # 2. Create DGEList
  dge <- DGEList(counts = counts)
  
  # 3. Filter lowly expressed genes
  keep <- filterByExpr(dge, group = colData$group)
  dge <- dge[keep,, keep.lib.sizes = FALSE]
  
  # 4. Normalize
  dge <- calcNormFactors(dge)
  
  # 5. Design matrix
  design <- model.matrix(~ Condition * Timepoint, data = colData)
  colnames(design) <- make.names(colnames(design))
  
  # 6. Voom transformation
  v <- voom(dge, design, plot = FALSE)
  
  # 7. Fit model
  fit <- lmFit(v, design)
  fit <- eBayes(fit)
  
  # 8. Extract results for 1DPI
  res_1dpi <- topTable(fit, coef = "ConditionInf", number = Inf, sort.by = "P")
  res_1dpi$SeqName <- rownames(res_1dpi)
  res_1dpi <- res_1dpi[, c("SeqName", setdiff(names(res_1dpi), "SeqName"))]
  res_1dpi <- res_1dpi[res_1dpi$adj.P.Val < 0.05, ]
  rownames(res_1dpi) <- NULL
  res_1dpi<-merge(res_1dpi, annotation.df_unique, by="SeqName")
  write.csv(res_1dpi, paste0("./pseudobulk_analysis/cluster", i, "_limma_DEG_1DPI.csv"))
  
  # 9. Create contrast for 5DPI
  contrast_matrix <- makeContrasts(
    Inf_5DPI_vs_Ctr_5DPI = ConditionInf + ConditionInf.Timepoint5DPI,
    levels = design
  )
  
  # 10. Apply contrast and extract results
  fit2 <- contrasts.fit(fit, contrast_matrix)
  fit2 <- eBayes(fit2)
  res_5dpi <- topTable(fit2, coef = "Inf_5DPI_vs_Ctr_5DPI", number = Inf, sort.by = "P")
  res_5dpi$SeqName <- rownames(res_5dpi)
  res_5dpi <- res_5dpi[, c("SeqName", setdiff(names(res_5dpi), "SeqName"))]
  res_5dpi <- res_5dpi[res_5dpi$adj.P.Val < 0.05, ]
  rownames(res_5dpi) <- NULL
  res_5dpi<-merge(res_5dpi, annotation.df_unique, by="SeqName")
  write.csv(res_5dpi, paste0("./pseudobulk_analysis/cluster", i, "_limma_DEG_5DPI.csv"))  
  # 11. PCA plot
  expr_pca <- t(v$E)
  pca <- prcomp(expr_pca, center = TRUE, scale. = TRUE)
  percentVar <- round(100 * (pca$sdev^2 / sum(pca$sdev^2))[1:2], 1)
  pca_df <- as.data.frame(pca$x[, 1:2])
  pca_df$Sample <- rownames(pca_df)
  pca_df <- cbind(pca_df, colData[rownames(pca_df), ])
  
  pdf(paste0("./plots/pseudobulkRNAseq_PCA_cluster", i, ".pdf"), width = 5, height = 5)
  print(
    ggplot(pca_df, aes(x = PC1, y = PC2, color = Condition, shape = Timepoint, label = Sample)) +
      geom_point(size = 4) +
      geom_text(vjust = -0.5, size = 3) +
      xlab(paste0("PC1: ", percentVar[1], "% variance")) +
      ylab(paste0("PC2: ", percentVar[2], "% variance")) +
      theme_minimal()
  )
  dev.off()
  
  # 12. Volcano plot
  res_5dpi <- res_5dpi %>%
    mutate(
      gene = rownames(res_5dpi),
      sig = case_when(
        adj.P.Val < 0.05 & abs(logFC) > 1 ~ "DE",
        TRUE ~ "NS"
      )
    )
  
  top_genes <- res_5dpi %>%
    filter(sig == "DE") %>%
    arrange(adj.P.Val) %>%
    slice(1:10)
  
  pdf(paste0("./plots/pseudobulkRNAseq_vplot_cluster", i, ".pdf"), width = 5, height = 5)
  print(
    ggplot(res_5dpi, aes(x = logFC, y = -log10(P.Value), color = sig)) +
      geom_point(alpha = 0.6, size = 2) +
      scale_color_manual(values = c("DE" = "firebrick", "NS" = "gray")) +
      geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black") +
      geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black") +
      theme_minimal() +
      labs(
        title = paste("Volcano Plot: Cluster", i, "- 5DPI Inf vs Ctr"),
        x = "Log2 Fold Change",
        y = "-log10(P-value)"
      ) +
      geom_text_repel(data = top_genes, aes(label = gene), size = 3)
  )
  dev.off()
  
}



```


## visualize pseudobulk differential expression analysis

```R

library(dplyr)
library(readr)
library(stringr)
library(purrr)

setwd("~/pseudobulk_analysis")
# Set your folder path
results_dir <- "."  # change this to your actual path

# List all relevant files
files <- list.files(results_dir, pattern = "^cluster\\d+_limma_DEG_\\d+DPI\\.csv$", full.names = TRUE)



deg_list <- lapply(files, function(file) {
  df <- read_csv(file, col_types = cols(.default = col_guess()))
  
  # Rename first column if unnamed
  if (is.null(names(df)[1]) || names(df)[1] == "...1") {
    names(df)[1] <- "gene"
  }
  return(df)
})


colnames(deg_list[[1]])


# Read and merge all files
deg_list <- map(files, ~ {
  df <- read_csv(.x, col_types = cols(.default = "c"))  # force all columns to character
  df$cluster <- str_extract(.x, "(?<=cluster)\\d+")
  df$dpi <- str_extract(.x, "(?<=DEG_)\\d+(?=DPI)")
  df
})

# Merge into one data frame and convert numeric columns where appropriate
merged_deg <- bind_rows(deg_list) %>%
  mutate(across(c(logFC, AveExpr, t, P.Value, adj.P.Val, B, Length, e.Value, sim.mean), as.numeric),
         cluster = as.integer(cluster),
         dpi = as.integer(dpi))

library(tidyr)

# Step 1: Select relevant columns
deg_wide <- merged_deg %>%
  select(
    SeqName, Description, cluster, dpi,
    logFC, adj.P.Val
  ) %>%
  # Step 2: Create a combined identifier for each condition
  mutate(label = paste(cluster, dpi, sep = "_")) %>%
  # Step 3: Pivot longer to get one row per gene per label per metric
  pivot_longer(cols = c(logFC, adj.P.Val),
               names_to = "metric",
               values_to = "value") %>%
  mutate(column_name = paste(metric, label, sep = "_")) %>%
  select(SeqName, Description, column_name, value) %>%
  # Step 4: Pivot wider to get one row per gene
  pivot_wider(names_from = column_name, values_from = value)

write.csv(deg_wide, "Pseudobulk_cluster_summaryTable.csv")


library(UpSetR)

# Convert the list of DEGs into a binary matrix for UpSet
library(data.table)

cluster_labels <- c(
  "17" = "Xylem_parenchyma_17",
  "16" = "Xylem_parenchyma_16",
  "11" = "Phloem_parenchyma_11",
  "10" = "Phloem_parenchyma_10",
  "5"  = "Mesophyll_5",
  "4"  = "Mesophyll_4",
  "20" = "Mesophyll_20",
  "2"  = "Mesophyll_2",
  "15" = "Mesophyll_15",
  "13" = "Mesophyll_13",
  "12" = "Mesophyll_12",
  "1"  = "Mesophyll_1",
  "0"  = "Mesophyll_0",
  "19" = "Guard_cells_19",
  "9"  = "Epidermis_9",
  "8"  = "Epidermis_8",
  "7"  = "Epidermis_7",
  "6"  = "Epidermis_6",
  "3"  = "Epidermis_3",
  "14" = "Epidermis_14",
  "18" = "Companion_cells_18"
)


# Apply the mapping
merged_deg <- merged_deg %>%
  mutate(cluster = cluster_labels[as.character(cluster)])



# Filter only significant DEGs
deg_filtered <- merged_deg %>%
  filter(adj.P.Val < 0.05)


deg_filtered <- deg_filtered %>%
  filter(logFC < 0)


deg_filtered <- deg_filtered %>%
  filter(dpi=="5")

# Create list of gene sets per cell type
deg_listD <- split(deg_filtered$SeqName, deg_filtered$cluster)


# repeat for all elements
upset_matrix <- fromList(deg_list)

# Plot
pdf("Upset_clusters_downDEGs_5dpi.pdf", width = 8, height = 5)

UpSetR::upset(upset_matrix, order.by = "freq", 
              sets = names(deg_list),
              main.bar.color = "darkblue",
              sets.bar.color = "darkgreen",
              
              # Make the histogram (main bar) shorter
              mb.ratio = c(0.3, 0.7),       # smaller = shorter main bar plot
              # Make the intersection size points bigger
              point.size = 2,            # default is 2
              line.size = 0.5,           # thicker lines connecting the points
              text.scale = c(1.2, 1, 1, 1, 1.5, 1.2)  # scale texts (e.g., axis labels, counts)
              )

dev.off()



# Filter only significant DEGs
deg_filtered <- merged_deg %>%
  filter(adj.P.Val < 0.05)


deg_filtered <- deg_filtered %>%
  filter(logFC > 0)


deg_filtered <- deg_filtered %>%
  filter(dpi=="5")


# Create list of gene sets per cell type
deg_list <- split(deg_filtered$SeqName, deg_filtered$cluster)

upset_input <- as.data.frame(data.table::transpose(deg_list))
colnames(upset_input) <- names(deg_list)
upset_matrix <- fromList(deg_list)

# Plot
pdf("Upset_clusters_upDEGs_5dpi.pdf", width = 8, height = 5)

UpSetR::upset(upset_matrix, order.by = "freq", 
              sets = names(deg_list),
              main.bar.color = "darkred",
              sets.bar.color = "darkorange",
              
              # Make the histogram (main bar) shorter
              mb.ratio = c(0.3, 0.7),       # smaller = shorter main bar plot
              # Make the intersection size points bigger
              point.size = 2,            # default is 2
              line.size = 0.5,           # thicker lines connecting the points
              text.scale = c(1.2, 1, 1, 1, 1.5, 1.2)  # scale texts (e.g., axis labels, counts)
              )

dev.off()



# Filter only significant DEGs
deg_filtered <- merged_deg %>%
  filter(adj.P.Val < 0.05)


deg_filtered <- deg_filtered %>%
  filter(logFC < 0)


deg_filtered <- deg_filtered %>%
  filter(dpi=="1")

# Create list of gene sets per cell type
deg_list <- split(deg_filtered$SeqName, deg_filtered$cluster)


# repeat for all elements
upset_matrix <- fromList(deg_list)

# Plot
pdf("Upset_clusters_downDEGs_1dpi.pdf", width = 8, height = 5)

UpSetR::upset(upset_matrix, order.by = "freq", 
              sets = names(deg_list),
              main.bar.color = "darkblue",
              sets.bar.color = "darkgreen",
              
              # Make the histogram (main bar) shorter
              mb.ratio = c(0.3, 0.7),       # smaller = shorter main bar plot
              # Make the intersection size points bigger
              point.size = 2,            # default is 2
              line.size = 0.5,           # thicker lines connecting the points
              text.scale = c(1.2, 1, 1, 1, 1.5, 1.2)  # scale texts (e.g., axis labels, counts)
              )

dev.off()



# Filter only significant DEGs
deg_filtered <- merged_deg %>%
  filter(adj.P.Val < 0.05)


deg_filtered <- deg_filtered %>%
  filter(logFC > 0)


deg_filtered <- deg_filtered %>%
  filter(dpi=="1")


# Create list of gene sets per cell type
deg_list <- split(deg_filtered$SeqName, deg_filtered$cluster)

upset_input <- as.data.frame(data.table::transpose(deg_list))
colnames(upset_input) <- names(deg_list)
upset_matrix <- fromList(deg_list)

# Plot
pdf("Upset_clusters_upDEGs_1dpi.pdf", width = 8, height = 5)

UpSetR::upset(
  upset_matrix,
  order.by = "freq", 
  sets = names(deg_list),
  main.bar.color = "darkred",
  sets.bar.color = "darkorange",
  
  # Make the histogram (main bar) shorter
  mb.ratio = c(0.3, 0.7),       # smaller = shorter main bar plot
  # Make the intersection size points bigger
  point.size = 2,            # default is 2
  line.size = 0.5,           # thicker lines connecting the points
  text.scale = c(1.2, 1, 1, 1, 1.5, 1.2)  # scale texts (e.g., axis labels, counts)
)

dev.off()

```


## visualize differentially expressed defense related genes per cluster
```R

defgenes<-read.csv("DefenseGenes_CS08.csv")
colnames(defgenes)[3]<-"SeqName"
# defgenes$SeqName <- gsub("_", "-", defgenes$SeqName)  # Replace all hyphens with underscores
merged_deg$SeqName <- gsub("-", "_", merged_deg$SeqName)  # Replace all hyphens with underscores
deg_defensegenes<-merge(merged_deg,defgenes,by="SeqName")

# Load necessary libraries
library(dplyr)
library(tidyr)
library(stringr)

# Read your input data (replace with your actual file)
df <- deg_defensegenes

# Filter significant DEGs (e.g., adj.P.Val < 0.05)
deg_df <- df %>% filter(adj.P.Val < 0.05)

# Determine up/down regulation
deg_df <- deg_df %>%
  mutate(Regulation = case_when(
    logFC > 0 ~ "Upregulated",
    logFC < 0 ~ "Downregulated",
    TRUE ~ "Not_significant"
  ))

# Summarize counts per cluster, dpi, functional category and regulation
summary_table <- deg_df %>%
  group_by(cluster, dpi, Functional.category, Regulation) %>%
  summarise(Gene_Count = n(), .groups = "drop") %>%
  pivot_wider(names_from = Regulation, values_from = Gene_Count, values_fill = 0)

# Convert to long format for ggplot
plot_data <- summary_table %>%
  pivot_longer(cols = c("Upregulated", "Downregulated"), 
               names_to = "Direction", 
               values_to = "Count")

# Create a new variable to combine direction and dpi
plot_data$DirectionDPI <- paste0(plot_data$Direction, "_", plot_data$dpi)


custom_colors <- c(
  "Abscisic acid-mediated signaling pathway" = "#E69F00",
  "Calcium signaling" = "#56B4E9",
  "Cell wall reinforcement" = "#009E73",
  "Ethylene-mediated signaling pathway" = "#F0E442",
  "Jasmonic acid-mediated signaling pathway" = "#D55E00",
  "MAPK signaling" = "#CC79A7",
  "NLRs" = "#0072B2",
  "Phytoalexin biosynthesis" = "#00BFC4",
  "PR proteins" = "#F564E3",
  "Receptor-like kinases" = "#009E73",
  "ROS production" = "#F8766D",
  "ROS scavenging" = "#AB56B4",
  "Salicylic acid-mediated signaling pathway" = "#999999"
)


pdf("DEGs_defensegenes.pdf", width = 15, height = 10)
ggplot(plot_data, aes(x = cluster, y = Count, fill = Functional.category)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ DirectionDPI, scales = "free_y") +
  labs(title = "Defense Gene Regulation per Cluster and dpi",
       x = "Cluster",
       y = "Number of Genes") +
  scale_fill_manual(values = custom_colors) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 14),
    legend.text = element_text(size = 14)
  )


dev.off()
```

## gene ontology for differentially expressed genes per cluster
```R
####gene ontology DEGs#########


merged_deg <- merged_deg %>%
  mutate(
    direction = case_when(
      logFC > 0 ~ "up",
      logFC < 0 ~ "down",
      TRUE ~ "no_change"
    )
  )

annotation.df<-read.csv("your_ref_annotation")


all_genes <- unique(annotation.df_unique$SeqName)


# 4. Prepare gene2GO mapping
gene2go <- annotation.df_unique %>%
  dplyr::filter(!is.na(GO.IDs) & GO.IDs != "NA" & GO.IDs != "no GO terms") %>%
  tidyr::separate_rows(GO.IDs, sep = ";\\s*") %>%
  dplyr::select(SeqName, GO.IDs) %>%
  distinct()

# 5. Create geneID2GO mapping (cleaned)
geneID2GO <- with(gene2go, split(GO.IDs, SeqName))
geneID2GO_clean <- lapply(geneID2GO, function(go_terms) {
  gsub("^[FPC]:", "", go_terms)
})


library(topGO)
library(dplyr)
library(tidyr)
library(ggplot2)

# dir.create("topgo_results_clusters", showWarnings = FALSE)

# # DEG dataframe structure assumed:
# # deg_df has columns: SeqName, logFC, adj.P.Val, Timepoint, CellType
# timepoints <- unique(merged_deg$dpi)
# celltypes <- unique(merged_deg$cluster)

# List of ontologies
ontologies <- c("BP", "MF", "CC")

# Initialize list to collect results
all_go_results <- list()

# Direction="up"
# Loop over unique cell types, timepoints, and directions
for (celltype in unique(merged_deg$cluster)) {
  for (timepoint in unique(merged_deg$dpi)) {
    for (Direction in c("up", "down")) {
      
      # Filter DEGs based on cluster, timepoint, and direction
      deg_subset <- merged_deg %>%
        filter(cluster == celltype, dpi == timepoint, direction == Direction)
      
      # Skip if no genes
      if (nrow(deg_subset) == 0) next
      
      # Get DE gene IDs
      de_genes <- unique(deg_subset$SeqName)
      
      # Create gene list (binary vector: 1 if DEG, 0 otherwise)
      geneList <- factor(as.integer(all_genes %in% de_genes))
      names(geneList) <- all_genes
      
      for (ont in ontologies) {
        message("Running topGO for ", celltype, " - ", timepoint, " - ", Direction, " - ", ont)
        
        # Prepare topGO object
        GOdata <- new("topGOdata",
                      ontology = ont,
                      allGenes = geneList,
                      annot = annFUN.gene2GO,
                      gene2GO = geneID2GO_clean,
                      nodeSize = 5)
        
        # Fisher's exact test
        resultFisher <- runTest(GOdata, algorithm = "classic", statistic = "fisher")
        
        # Extract top 10 GO terms
        go_table <- GenTable(GOdata,
                             classicFisher = resultFisher,
                             topNodes = 10)
        
        # If results found, process and store them
        if (nrow(go_table) > 0) {
          go_table$CellType <- celltype
          go_table$Timepoint <- timepoint
          go_table$Dir <- Direction
          go_table$Ontology <- ont
          
          # Clean p-values
          go_table$classicFisher <- gsub("< ", "", go_table$classicFisher)
          go_table$classicFisher <- as.numeric(go_table$classicFisher)
          go_table$log10_pval <- -log10(go_table$classicFisher)
          
          all_go_results[[length(all_go_results) + 1]] <- go_table
        }
      }
    }
  }
}

# Combine all GO results
go_df <- do.call(rbind, all_go_results)



go_df_sig<-go_df[which(go_df$log10_pval>2),]
# table(go_df_sig$CellType)

# go_df_sig_BP<-go_df_sig[which(go_df_sig$Ontology=="BP"),] %>% filter(Dir == "up")

pdf("topGO_clusters_BP_up.pdf", width = 10, height = 12)

# Upregulated
ggplot(go_df_sig[which(go_df_sig$Ontology=="BP"),] %>% filter(Dir == "up"), 
       aes(x = CellType, y = Term)) +
  geom_point(aes(size = Significant, color = log10_pval)) +
  scale_color_viridis_c(option = "plasma") +
  facet_wrap(~ Timepoint) +
  theme_bw(base_size = 12) +
  labs(
    title = "GO enrichment (Upregulated genes)",
    x = "Cell Type",
    y = "GO Term",
    size = "DE Genes",
    color = expression(-log[10](p))
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(size = 10))
dev.off()

pdf("topGO_clusters_BP_down.pdf", width = 10, height = 12)

# Downregulated
ggplot(go_df_sig[which(go_df_sig$Ontology=="BP"),]  %>% filter(Dir == "down"), 
       aes(x = CellType, y = Term)) +
  geom_point(aes(size = Significant, color = log10_pval)) +
  scale_color_viridis_c(option = "viridis") +
  facet_wrap(~ Timepoint) +
  theme_bw(base_size = 12) +
  labs(
    title = "GO enrichment (Downregulated genes)",
    x = "Cell Type",
    y = "GO Term",
    size = "DE Genes",
    color = expression(-log[10](p))
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(size = 10))
dev.off()


```
